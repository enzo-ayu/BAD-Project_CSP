{% extends 'clinic/base.html' %}
{% block content %}

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    .quick-ranges {
        background: white;
        min-width: 160px;
        padding: 10px;
        border-right: 1px solid #eee;
        font-size: 14px;
    }
    .quick-ranges .quick-item {
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 6px;
        color: #333;
        user-select: none;
        white-space: nowrap;
    }
    .quick-ranges .quick-item:hover { background: #f1f1f1; }
    .flatpickr-calendar { min-width: 650px !important; overflow: visible !important; }
    .flatpickr-innerContainer { display: flex !important; align-items: stretch !important; }
    .flatpickr-rContainer { flex: 1 !important; display: flex !important; flex-direction: column !important; }
    .flatpickr-months { display: flex !important; width: 100% !important; justify-content: space-between !important; align-items: center !important; padding: 6px 10px !important; border-bottom: 1px solid #eee; box-sizing: border-box; }
    .flatpickr-month, .flatpickr-current-month { display: flex !important; align-items: center !important; gap: 8px; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important; }
    .flatpickr-current-month .flatpickr-monthDropdown-months { display: inline-block !important; visibility: visible !important; opacity: 1 !important; font-size: 14px !important; }
    .flatpickr-current-month input.cur-year { display: inline-block !important; visibility: visible !important; opacity: 1 !important; width: 80px !important; min-width: 80px !important; font-size: 14px !important; padding: 2px 4px !important; }
    .flatpickr-days { width: 100% !important; }
    .dayContainer { width: 100% !important; min-width: 100% !important; max-width: 100% !important; }
</style>

{% if messages %}
<div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Sales History</h2>

    <form method="GET" class="d-flex gap-2 align-items-center">
        <input type="text" id="datePicker" name="date" value="{{ date_filter }}"
               class="form-control" placeholder="Select date or range"
               style="min-width: 220px;">
        <input type="text" name="q" value="{{ query }}"
               class="form-control" placeholder="Search" style="min-width: 220px;">
        <button type="submit" class="btn btn-primary">Filter</button>
        {% if query or date_filter %}
        <a href="{% url 'sales_db' %}" class="btn btn-outline-secondary">Reset</a>
        {% endif %}
    </form>
</div>

<table class="table table-bordered bg-white">
    <thead class="table-info">
        <tr>
            <th>Date</th>
            <th>Patient</th>
            <th>Product Total</th>
            <th>Treatment Total</th>
            <th>Total Amount</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for sale in sales %}
        <tr>
            <td>{{ sale.transaction_date }}</td>
            <td>
                {{ sale.patient.last_name }},
                {{ sale.patient.first_name }}
                {{ sale.patient.middle_name|default:"" }}
                {{ sale.patient.suffix|default:"" }}
            </td>
            <td>₱{{ sale.total_price_of_products|floatformat:2 }}</td>
            <td>₱{{ sale.total_price_of_treatments|floatformat:2 }}</td>
            <td class="fw-bold">₱{{ sale.total_amount|floatformat:2 }}</td>
            <td>
                <div class="d-flex gap-2">
                    <a href="{% url 'view_chargeslip' sale.transaction_id %}"
                       class="btn btn-info btn-sm text-white">Details</a>
                    <a href="{% url 'sales_update' sale.transaction_id %}"
                       class="btn btn-warning btn-sm text-white">Update</a>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">
                No sales found{% if query or date_filter %} for your filters{% endif %}.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }

flatpickr("#datePicker", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "2014-01-01",
    maxDate: "2030-12-31",
    allowInput: true,
    onReady: function(selectedDates, dateStr, instance) {
        const panel = document.createElement("div");
        panel.className = "quick-ranges";
        panel.innerHTML = `
            <div class="quick-item" data-range="today">Today</div>
            <div class="quick-item" data-range="yesterday">Yesterday</div>
            <div class="quick-item" data-range="lastweek">Last week</div>
            <div class="quick-item" data-range="lastmonth">Last month</div>
            <div class="quick-item" data-range="lastquarter">Last quarter</div>
        `;
        instance.calendarContainer.style.display = "flex";
        instance.calendarContainer.insertBefore(panel, instance.calendarContainer.firstChild);
        panel.addEventListener("click", function(e) {
            if (!e.target.classList.contains("quick-item")) return;
            const type = e.target.dataset.range;
            const today = startOfDay(new Date());
            let start, end;
            if (type === "today") { start = end = today; }
            else if (type === "yesterday") { start = end = addDays(today, -1); }
            else if (type === "lastweek") { start = addDays(today, -6); end = today; }
            else if (type === "lastmonth") { start = addDays(today, -29); end = today; }
            else if (type === "lastquarter") { start = addDays(today, -89); end = today; }
            instance.setDate([start, end], true);
            instance.close();
        });
    }
});
</script>

{% endblock %}