{% extends 'clinic/base.html' %}
{% block content %}

<div class="container bg-light p-4 rounded shadow-sm">

{% if messages %}
<div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<a href="{% url 'sales_db' %}" class="text-decoration-none text-muted">← Back</a>

<form method="POST">
{% csrf_token %}

<div class="row mt-3">
    <!-- LEFT COLUMN: Transaction Info -->
    <div class="col-md-4">
        <div class="mb-3">
            <label>Transaction ID</label>
            <input class="form-control" value="{{ sale.transaction_id|stringformat:'07d' }}" disabled>
        </div>
        <div class="mb-3">
            <label>Transaction Date <span class="text-danger">*</span></label>
            <input type="date" name="transaction_date"
                   value="{{ sale.transaction_date|date:'Y-m-d' }}"
                   class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Mode of Payment <span class="text-danger">*</span></label>
            <select name="mode_of_payment" class="form-control" required>
                <option value="" disabled>Select...</option>
                <option value="Cash" {% if sale.mode_of_payment == "Cash" %}selected{% endif %}>Cash</option>
                <option value="Card" {% if sale.mode_of_payment == "Card" %}selected{% endif %}>Card</option>
                <option value="GCash" {% if sale.mode_of_payment == "GCash" %}selected{% endif %}>GCash</option>
                <option value="Bank Transfer" {% if sale.mode_of_payment == "Bank Transfer" %}selected{% endif %}>Bank Transfer</option>
            </select>
        </div>
    </div>

    <!-- RIGHT COLUMN: Products & Treatments Tables -->
    <div class="col-md-8">

        <!-- PRODUCTS TABLE -->
        <h5>Products</h5>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="product-section">
                {% for item in products %}
                <tr class="product-row">
                    <td>
                        <select name="product_ids" class="form-control product-select">
                            <option value="" disabled>Select Product</option>
                            {% for p in all_products %}
                            <option value="{{ p.product_id }}" data-price="{{ p.unit_cost }}"
                                    {% if p == item.product %}selected{% endif %}>
                                {{ p.product_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" name="product_qtys" value="{{ item.quantity_purchased }}" class="form-control product-qty" min="1"></td>
                    <td><input type="text" value="{{ item.subtotal }}" class="form-control product-subtotal" readonly></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-btn">✕</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-primary mb-3" id="addProductBtn">+ Add Product</button>

        <!-- TREATMENTS TABLE -->
        <h5>Treatments</h5>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Treatment</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="treatment-section">
                {% for item in treatments %}
                <tr class="treatment-row">
                    <td>
                        <select name="treatment_ids" class="form-control treatment-select">
                            <option value="" disabled>Select Treatment</option>
                            {% for t in all_treatments %}
                            <option value="{{ t.treatment_id }}" data-price="{{ t.treatment_cost }}"
                                    {% if t == item.treatment %}selected{% endif %}>
                                {{ t.treatment_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" name="treatment_qtys" value="{{ item.quantity_purchased }}" class="form-control treatment-qty" min="1"></td>
                    <td><input type="text" value="{{ item.subtotal }}" class="form-control treatment-subtotal" readonly></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-btn">✕</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-primary mb-3" id="addTreatmentBtn">+ Add Treatment</button>

        <!-- TOTALS -->
        <div class="d-flex justify-content-end">
            <div class="w-50">
                <div class="mb-2">
                    <label>Product Total</label>
                    <input type="text" id="productTotal" class="form-control" readonly>
                </div>
                <div class="mb-2">
                    <label>Treatment Total</label>
                    <input type="text" id="treatmentTotal" class="form-control" readonly>
                </div>
                <div class="mb-2">
                    <label>Total Amount</label>
                    <input type="text" id="grandTotal" name="grandTotal" class="form-control fw-bold" readonly>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
        Delete Sale
    </button>
    <button type="submit" class="btn btn-info text-white px-4">
        Save Changes
    </button>
</div>
</form>

</div>

<!-- ================= TEMPLATES ================= -->
<template id="product-template">
<tr class="product-row">
    <td>
        <select name="product_ids" class="form-control product-select">
            <option value="" selected disabled>Select Product</option>
            {% for p in all_products %}
            <option value="{{ p.product_id }}" data-price="{{ p.unit_cost }}">{{ p.product_name }}</option>
            {% endfor %}
        </select>
    </td>
    <td><input type="number" name="product_qtys" value="1" class="form-control product-qty" min="1"></td>
    <td><input type="text" value="0.00" class="form-control product-subtotal" readonly></td>
    <td><button type="button" class="btn btn-danger btn-sm remove-btn">✕</button></td>
</tr>
</template>

<template id="treatment-template">
<tr class="treatment-row">
    <td>
        <select name="treatment_ids" class="form-control treatment-select">
            <option value="" selected disabled>Select Treatment</option>
            {% for t in all_treatments %}
            <option value="{{ t.treatment_id }}" data-price="{{ t.treatment_cost }}">{{ t.treatment_name }}</option>
            {% endfor %}
        </select>
    </td>
    <td><input type="number" name="treatment_qtys" value="1" class="form-control treatment-qty" min="1"></td>
    <td><input type="text" value="0.00" class="form-control treatment-subtotal" readonly></td>
    <td><button type="button" class="btn btn-danger btn-sm remove-btn">✕</button></td>
</tr>
</template>

<!-- ================= JAVASCRIPT ================= -->
<script>
// ================= SELECT2 INIT =================
function initSelect2() {
    $('.product-select').select2({
        placeholder: 'Search product...',
        width: '100%',
        dropdownParent: $('#product-section')
    });
    $('.treatment-select').select2({
        placeholder: 'Search treatment...',
        width: '100%',
        dropdownParent: $('#treatment-section')
    });
}

// ================= ADD ROWS =================
document.getElementById("addProductBtn").addEventListener("click", function() {
    const template = document.getElementById("product-template").content.cloneNode(true);
    const tbody = document.getElementById("product-section");
    tbody.appendChild(template);

    const newSelect = tbody.querySelector(".product-row:last-child .product-select");
    $(newSelect).select2({ placeholder: 'Search product...', width: '100%', dropdownParent: $('#product-section') });
    attachSelectListeners(newSelect);

    calculateTotals();
});

document.getElementById("addTreatmentBtn").addEventListener("click", function() {
    const template = document.getElementById("treatment-template").content.cloneNode(true);
    const tbody = document.getElementById("treatment-section");
    tbody.appendChild(template);

    const newSelect = tbody.querySelector(".treatment-row:last-child .treatment-select");
    $(newSelect).select2({ placeholder: 'Search treatment...', width: '100%', dropdownParent: $('#treatment-section') });
    attachSelectListeners(newSelect);

    calculateTotals();
});

// ================= ATTACH CHANGE LISTENER =================
function attachSelectListeners(selectElement) {
    selectElement.addEventListener('change', function() {
        setPrice(selectElement);
    });
}

// ================= REMOVE ROW =================
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-btn")) {
        const row = e.target.closest(".product-row, .treatment-row");
        if (row) row.remove();
        calculateTotals();
    }
});

// ================= QUANTITY INPUT CHANGES =================
document.addEventListener("input", function(e) {
    if (e.target.classList.contains("product-qty") || e.target.classList.contains("treatment-qty")) {
        calculateTotals();
    }
});

// ================= SET PRICE & MERGE DUPLICATES =================
function setPrice(selectElement) {
    const row = selectElement.closest(".product-row, .treatment-row");
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const actualId = selectedOption.dataset.id;
    const price = parseFloat(selectElement.value) || 0;

    // Update hidden ID input and price input
    row.querySelector(".id-input").value = actualId;
    row.querySelector(".price-input").value = price.toFixed(2);

    // Merge duplicates if needed
    if (selectElement.classList.contains("product-select")) mergeDuplicateProducts(selectElement);
    if (selectElement.classList.contains("treatment-select")) mergeDuplicateTreatments(selectElement);

    calculateTotals();
}

function mergeDuplicateProducts(currentSelect) {
    const currentRow = currentSelect.closest(".product-row");
    const currentId = currentRow.querySelector(".id-input").value;
    if (!currentId) return;
    const currentQty = parseFloat(currentRow.querySelector(".product-qty").value || 0);
    document.querySelectorAll(".product-row").forEach(row => {
        if (row === currentRow) return;
        const idInput = row.querySelector(".id-input");
        if (idInput && idInput.value === currentId) {
            row.querySelector(".product-qty").value = parseFloat(row.querySelector(".product-qty").value || 0) + currentQty;
            currentRow.remove();
        }
    });
}

function mergeDuplicateTreatments(currentSelect) {
    const currentRow = currentSelect.closest(".treatment-row");
    const currentId = currentRow.querySelector(".id-input").value;
    if (!currentId) return;
    const currentQty = parseFloat(currentRow.querySelector(".treatment-qty").value || 0);
    document.querySelectorAll(".treatment-row").forEach(row => {
        if (row === currentRow) return;
        const idInput = row.querySelector(".id-input");
        if (idInput && idInput.value === currentId) {
            row.querySelector(".treatment-qty").value = parseFloat(row.querySelector(".treatment-qty").value || 0) + currentQty;
            currentRow.remove();
        }
    });
}

// ================= CALCULATE TOTALS =================
function calculateTotals() {
    let productTotal = 0;
    let treatmentTotal = 0;

    document.querySelectorAll(".product-row").forEach(row => {
        const qty = parseFloat(row.querySelector(".product-qty").value || 0);
        const price = parseFloat(row.querySelector(".price-input").value || 0);
        row.querySelector(".product-subtotal").value = (qty * price).toFixed(2);
        productTotal += qty * price;
    });

    document.querySelectorAll(".treatment-row").forEach(row => {
        const qty = parseFloat(row.querySelector(".treatment-qty").value || 0);
        const price = parseFloat(row.querySelector(".price-input").value || 0);
        row.querySelector(".treatment-subtotal").value = (qty * price).toFixed(2);
        treatmentTotal += qty * price;
    });

    document.getElementById("productTotal").value = productTotal.toFixed(2);
    document.getElementById("treatmentTotal").value = treatmentTotal.toFixed(2);
    document.getElementById("grandTotal").value = (productTotal + treatmentTotal).toFixed(2);
}

// ================= INITIALIZE ON PAGE LOAD =================
window.onload = function() {
    initSelect2();
    document.querySelectorAll(".product-select").forEach(attachSelectListeners);
    document.querySelectorAll(".treatment-select").forEach(attachSelectListeners);
    calculateTotals();
};
</script>
{% endblock %}